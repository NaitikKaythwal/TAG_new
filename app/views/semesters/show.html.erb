<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Page with Sidebar</title>
  <style>
    .sidebar {
      width: 250px;
      height: 100%;
      padding: 1rem;
      overflow-y: auto;
      background-color: #f8f9fa;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .sidebar h2, .sidebar h3, .sidebar h5 {
      color: #343a40;
    }
    .sidebar a {
      color: #343a40;
    }
    .sidebar .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: #ffffff;
    }

    @media (max-width: 992px) {
      .sidebar {
        display: none;
      }
    }

    .main-content {
      flex: 1;
      border: 2px solid #ffffff;
      border-radius: 10px;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container mt-3">
    <div class="d-flex">
      <div class="sidebar">
        <div>
          <div>
            <%= link_to semesters_path do %>
              <h2 style="z-index: 9999; position: relative;">
                <i class="bi bi-arrow-return-left"></i>
              </h2>
            <% end %>
            <h3><%= @semester.semester %> <%= @semester.year %></h3>
            <ul class="list-unstyled ps-0">
              <li class="border-top my-3"></li>
              <li>
                <div class="col-sm-8">
                  <%= bootstrap_form_with url: semester_team_path(@semester), method: "get", local: true do |f| %>
                    <%= f.select :team, @teams %>
                    <hr>
                    <%= f.select :sprint, @sprint_list %>
                    <%= f.submit "View" %>
                  <% end %>
                </div>
                <hr>
              </li>
              <li class="mb-1">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadCSVModal">
                  Upload CSV
                </button>
              </li>
              <li class="mb-1">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importStudentCSVModal">
                  Import Student CSV
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="main-content">
        <div class="row">
          <div class="mt-4 text-center">
            <% if team_exist(@teams) %>
              <h2 class="">Team Status</h2>
              <div class="mt-3 mb-3">
                <h5 class="">Legend:</h5>
                <ul class="list-inline">
                  <li class="list-inline-item">
                    <%= image_tag "check-circle-fill.svg", class: "", style: "height:16px" %> All Good
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "question-circle-fill.svg", class: "", style: "height:16px" %> No Data Uploaded
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "exclamation-circle-fill-yellow.svg", class: "", style: "height:16px" %> No Client Survey
                  </li>
                  <li class="list-inline-item">
                    <%= image_tag "exclamation-triangle-fill-red.svg", class: "", style: "height:16px" %> Poor Performance
                  </li>
                </ul>
              </div>
              <p>Note: Hover over warning symbol to see more details</p>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Team</th>
                    <%= sprint_header(@sprint_list) %>
                  </tr>
                </thead>
                <tbody>
                  <%= team_rows(@teams, @sprint_list, @flags) %>
                </tbody>
              </table>
            <% end %>
          </div>
        </div>
        <!-- This section starts the integration of Github API -->
        <div>
          <h1 id="github-commits" style="font-size: 2rem; margin-top: 0.5rem; margin-bottom: 0.5rem; text-align: center;">Github Commits</h1>
          
          <!-- Form to collect repo and sprint info -->
          <div id="github-repo-form">

              <!-- Style to align the input boxes for the request form -->
              <style>
                  label {
                      display: inline-block;
                      text-align: center;
                  }

                  input {
                      display: block;
                      margin-bottom: 10px;
                  }
              </style>

              <div style="text-align: center;">
                  <form id="github-form">
                      <!-- Team Name and Sprint Number -->
                      <div style="display: inline-block; text-align: center;">
                          <label for="team-name" style="margin-right: 10px;">Team </label>
                          <select id="team-name" required style="margin-right: 20px;">
                              <option value="" selected>Choose Team Name</option>
                              <% @team_names.each do |team| %>
                              <option value="<%= team %>"><%= team %></option>
                              <% end %>
                          </select>

                          <label for="sprint-number" style="margin-right: 10px;">Sprint: </label>
                          <select id="sprint-number" onchange="updateDates()" required style="margin-right: 20px;">
                              <option value="0" selected>Choose Sprint Number</option>
                              <option value="1">Sprint 1</option>
                              <option value="2">Sprint 2</option>
                              <option value="3">Sprint 3</option>
                              <option value="4">Sprint 4</option>
                          </select>
                      </div>

                      <!-- Hidden inputs for repo info -->
                      <label for="repo-owner" style="display: none;">Repository Owner: </label>
                      <input type="text" placeholder="Repo Owner" id="repo-owner" style="display: none;" required>

                      <label for="repo-name" style="display: none;">Repository Name: </label>
                      <input type="text" placeholder="Repo Name" id="repo-name" style="display: none;" required>

                      <label for="access-token" style="display: none;">Github Access Token: </label>
                      <input type="text" placeholder="Fine-grain Token" id="access-token" style="display: none;" required>

                      <label for="start-date" style="display: none;">Sprint Start Date: </label>
                      <input type="text" placeholder="YYYY-MM-DD" id="start-date" style="display: none;" required>

                      <label for="end-date" style="display: none;">Sprint End Date: </label>
                      <input type="text" placeholder="YYYY-MM-DD" id="end-date" style="display: none;" required>

                      <button type="submit" style="display: block; margin: 20px auto;">Get Commit Info</button>
                  </form>
              </div>

          </div>

          <script>
            const sprintDates = {
              "1": { start: '<%= @start_dates["start_date_sprint_1"] %>', end: '<%= @end_dates["end_date_sprint_1"] %>' },
              "2": { start: '<%= @start_dates["start_date_sprint_2"] %>', end: '<%= @end_dates["end_date_sprint_2"] %>' },
              "3": { start: '<%= @start_dates["start_date_sprint_3"] %>', end: '<%= @end_dates["end_date_sprint_3"] %>' },
              "4": { start: '<%= @start_dates["start_date_sprint_4"] %>', end: '<%= @end_dates["end_date_sprint_4"] %>' }
            };

            function updateDates() {
              const selectedSprint = document.getElementById('sprint-number').value;
              document.getElementById('start-date').value = sprintDates[selectedSprint].start;
              document.getElementById('end-date').value = sprintDates[selectedSprint].end;
            }

            // Assuming @team_names, @repo_owners, @repo_names, and @access_tokens are arrays
            const repoDetails = {};
            <% @team_names.each do |team_name| %>
              repoDetails['<%= team_name %>'] = {
                repo_owner: '<%= @repo_owners[team_name] %>',
                repo_name: '<%= @repo_names[team_name] %>',
                access_token: '<%= @access_tokens[team_name] %>'
              };
            <% end %>

            function updateTeams(){
              // Update the repository details based on the selected team name
              const selectedTeamName = document.getElementById('team-name').value;
              const selectedTeamDetails = repoDetails[selectedTeamName];
              document.getElementById('repo-owner').value = selectedTeamDetails.repo_owner;
              document.getElementById('repo-name').value = selectedTeamDetails.repo_name;
              document.getElementById('access-token').value = selectedTeamDetails.access_token;
            }

            // Event listener to call updateTeams() when the team name is changed
            document.getElementById('team-name').addEventListener('change', updateTeams);
          </script>
          

          <!-- Element for where the response is placed -->
          <div id="commit-list">
          </div>
          <div id="commit-table" style= "text-align: center;>
            <table id="commit-table" style="border-collapse: separate; border-spacing: 10px;">
              <thead>
                <tr>
                    <th>Author</th>
                    <th>Number of Commits</th>
                </tr>
              </thead>
              <tbody>
                  <!-- Commit data will be populated here -->
              </tbody>
            </table>

            <div>
              <canvas id="myChart"></canvas>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Upload CSV Modal -->
  <div class="modal fade" id="uploadCSVModal" tabindex="-1" aria-labelledby="uploadCSVModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadCSVModalLabel">Upload CSV</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= bootstrap_form_with model: @semester, url: semester_path(@semester), method: :patch, local: true do |f| %>
            <div class="form-outline mb-4">
              <%= f.file_field :client_csv, accept: 'text/csv', class: 'form-control form-control-lg', id: 'client_csv' %>
            </div>
            <div class="form-outline mb-4">
              <%= f.file_field :student_csv, accept: 'text/csv', class: 'form-control form-control-lg', id: 'student_csv' %>
            </div>
            <div class="d-flex justify-content-center mb-4">
              <%= f.submit "Update", class: "btn btn-primary btn-block btn-lg gradient-custom-4 text-white" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Import CSV File Modal for student_list -->
 <div class="modal fade" id="importStudentCSVModal" tabindex="-1" aria-labelledby="importCSVModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importCSVModalLabel">Import Student CSV File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with(url: import_home_path, multipart: true, html: { class: "import-form" }) do |form| %>
          <div class="form-group">
            <%= form.label :file, 'Select CSV File', class: "import-file-label" %>
            <%= form.file_field :file, accept: '.csv', class: "import-file-input" %>
          </div>
          <div class="d-flex justify-content-center mt-4">
            <%= form.submit 'Import', class: "btn btn-primary btn-block btn-lg gradient-custom-4 text-white import-button" %>
          </div>
        <% end %>

        <!-- Additional styling inside the modal body -->
        <div style="margin-top: 20px; padding: 15px; background-color: #f0f0f0; border-radius: 8px;">
      </div>
    </div>
  </div>
  
</div>

<!-- Allows the data from the github request to be shown -->
<%= javascript_include_tag 'survey_page/survey_scroll_navigation' %>
<%= javascript_include_tag 'survey_page/survey_page_expanding_cols' %>
<%= javascript_include_tag 'octokit', type: "module" %>



